name: CI

on:
  push:
    branches:
      - main
      - "claude/**"
  pull_request:
    branches:
      - main

jobs:
  # Pre-commit hooks job
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

  # Backend linting and type checking
  backend-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff linter
        run: ruff check .

      - name: Run Ruff formatter check
        run: ruff format --check .

      - name: Run mypy type checking
        run: mypy src || true # Allow mypy failures temporarily during migration

  # Auto-fix lint errors using Claude Code Action
  auto-fix-lint:
    name: Auto-Fix Lint Errors
    needs: [backend-quality, frontend-quality]
    if: failure() && secrets.ANTHROPIC_API_KEY != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR branch
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout push branch
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "claude-agent[bot]"
          git config user.email "claude-agent[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: |
          pip install ruff
          cd frontend && npm ci --legacy-peer-deps

      - name: Run Claude Agent Auto-Fix Lint
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: .github/prompts/fix-lint-errors.md
          allowed_tools: "Bash,Edit,Read,Write"
          max_turns: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push changes if any
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git push
            echo "Auto-fixes pushed"
          fi

  # Auto-fix type errors using Claude Code Action
  auto-fix-types:
    name: Auto-Fix Type Errors
    needs: auto-fix-lint
    if: always() && secrets.ANTHROPIC_API_KEY != '' && (needs.auto-fix-lint.result == 'success' || needs.auto-fix-lint.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check if type errors need fixing
        id: check
        run: |
          echo "Checking for type errors..."

      - name: Checkout PR branch
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout push branch
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull --rebase || true

      - name: Configure Git
        run: |
          git config user.name "claude-agent[bot]"
          git config user.email "claude-agent[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: |
          pip install mypy
          cd backend && pip install -e ".[dev]" || true
          cd ../frontend && npm ci --legacy-peer-deps

      - name: Check for type errors
        id: type-check
        continue-on-error: true
        run: |
          cd backend && mypy src --ignore-missing-imports 2>&1 | tee /tmp/mypy-output.txt || true
          cd ../frontend && npm run type-check 2>&1 | tee /tmp/tsc-output.txt || true
          if grep -q "error:" /tmp/mypy-output.txt || grep -q "error TS" /tmp/tsc-output.txt; then
            echo "has_errors=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Claude Agent Auto-Fix Types
        if: steps.type-check.outputs.has_errors == 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: .github/prompts/fix-type-errors.md
          allowed_tools: "Bash,Edit,Read,Write"
          max_turns: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push changes if any
        if: steps.type-check.outputs.has_errors == 'true'
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git push
            echo "Type fixes pushed"
          fi

  # Analyze test failures using Claude Code Action
  test-analysis:
    name: Analyze Test Failures
    needs: backend-tests
    if: failure() && secrets.ANTHROPIC_API_KEY != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout PR branch
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout push branch
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "claude-agent[bot]"
          git config user.email "claude-agent[bot]@users.noreply.github.com"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          cd backend && pip install -e ".[dev]"

      - name: Run Claude Agent Test Analysis
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt_file: .github/prompts/analyze-test-failures.md
          allowed_tools: "Bash,Edit,Read,Write"
          max_turns: 15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push changes if any
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git push
            echo "Test fixes pushed"
          fi

  # Backend tests
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest with coverage
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          ENVIRONMENT: test
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # Frontend linting and type checking (if applicable)
  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Run type checking
        run: npm run type-check
        continue-on-error: true

      - name: Build frontend
        run: npm run build

  # Security checks
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety

      - name: Run Bandit security linter
        run: bandit -r backend/src -ll
        continue-on-error: true

      - name: Check dependencies for known vulnerabilities
        run: |
          cd backend
          pip install -e ".[dev]"
          safety check --json
        continue-on-error: true

  # All checks passed
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - pre-commit
      - backend-quality
      - backend-tests
      - frontend-quality
      - security
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.pre-commit.result }}" != "success" ]] || \
             [[ "${{ needs.backend-quality.result }}" != "success" ]] || \
             [[ "${{ needs.backend-tests.result }}" != "success" ]]; then
            echo "Required checks failed"
            exit 1
          fi
          echo "All required checks passed!"
